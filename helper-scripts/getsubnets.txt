#!/bin/sh /etc/rc.common

START=98

URL="https://raw.githubusercontent.com/AlexFire-Dev/AllowDomains/main/out/openwrt/vpn-subnet.lst"
OUT="/etc/ipset/vpn-subnet.lst"
TMP="/tmp/vpn-subnet.lst"

start() {
    local count=0

    while true; do
        if curl -m 3 -fsS https://github.com >/dev/null 2>&1; then
            break
        fi
        echo "GitHub is not available. Check the internet availability [$count]"
        count=$((count+1))
        sleep 2
    done

    if ! curl -f -m 15 -sS "$URL" -o "$TMP"; then
        echo "Failed to download: $URL"
        return 1
    fi

    if [ ! -s "$TMP" ]; then
        echo "Downloaded list is empty. Not applying."
        return 1
    fi

    cp "$TMP" "$OUT" || return 1

    /etc/init.d/firewall reload >/dev/null 2>&1 || fw4 reload >/dev/null 2>&1

    echo "vpn_subnets updated: $(wc -l < "$OUT") entries"
    return 0
}
